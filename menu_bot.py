#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import os
import sys
import time
import logging
from pathlib import Path
from typing import Dict, Any

from dotenv import load_dotenv

# –ï—Å–ª–∏ —É –≤–∞—Å python-telegram-bot:
# v20+
try:
    from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
    from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
    PTB_VERSION = 20
except Exception:
    # v13 fallback (–Ω–µ –º–µ–Ω—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ API)
    from telegram import InlineKeyboardMarkup, InlineKeyboardButton
    from telegram.ext import Updater, CommandHandler, CallbackQueryHandler
    PTB_VERSION = 13

load_dotenv()

# --- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ---
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO").upper()
logging.basicConfig(
    level=getattr(logging, LOG_LEVEL, logging.INFO),
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",
    stream=sys.stdout,
)
logger = logging.getLogger("menu_bot")

# --- –ü—É—Ç–∏/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
BASE_DIR = Path(__file__).resolve().parent
STATE_DIR = BASE_DIR / "state"
STATE_FILE = STATE_DIR / "push_enabled.json"

MENU_BOT_TOKEN = os.getenv("MENU_BOT_TOKEN") or os.getenv("TELEGRAM_BOT_TOKEN")
ADMINS = set(
    [a.strip() for a in (os.getenv("ADMINS", "")).split(",") if a.strip()]
)

# --- –£—Ç–∏–ª–∏—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
DEFAULT_STATE = {"tvoi": True, "trnd": False}


def _safe_read_json(path: Path, default: Dict[str, Any]) -> Dict[str, Any]:
    try:
        if not path.exists():
            return dict(default)
        with path.open("r", encoding="utf-8") as f:
            data = json.load(f)
        # –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: bool –∏–ª–∏ {"enabled": bool}
        if isinstance(data, bool):
            return {"tvoi": bool(data), "trnd": bool(data)}
        if isinstance(data, dict):
            if "enabled" in data and ("tvoi" not in data or "trnd" not in data):
                en = bool(data.get("enabled"))
                data = {"tvoi": en, "trnd": en}
            # –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª—è
            for k, v in DEFAULT_STATE.items():
                data.setdefault(k, v)
            return data
        return dict(default)
    except Exception as e:
        logger.exception("Failed to read state: %s", e)
        return dict(default)


def _atomic_write_json(path: Path, data: Dict[str, Any]) -> None:
    tmp = path.with_suffix(".tmp")
    with tmp.open("w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    tmp.replace(path)


def get_state() -> Dict[str, Any]:
    STATE_DIR.mkdir(parents=True, exist_ok=True)
    return _safe_read_json(STATE_FILE, DEFAULT_STATE)


def set_state(new_state: Dict[str, Any]) -> Dict[str, Any]:
    # –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏ –ø–∏—à–µ–º –∞—Ç–æ–º–∞—Ä–Ω–æ
    st = get_state()
    st.update({k: bool(v) for k, v in new_state.items() if k in DEFAULT_STATE})
    _atomic_write_json(STATE_FILE, st)
    return st


def build_keyboard(st: Dict[str, Any]) -> InlineKeyboardMarkup:
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    tvoi_label = f"üì° TVOI: {'ON' if st['tvoi'] else 'OFF'}"
    trnd_label = f"üìà TRND: {'ON' if st['trnd'] else 'OFF'}"
    keyboard = [
        [InlineKeyboardButton(tvoi_label, callback_data="toggle_tvoi")],
        [InlineKeyboardButton(trnd_label, callback_data="toggle_trnd")],
        [InlineKeyboardButton("‚ÑπÔ∏è –ö–æ–º–∞–Ω–¥—ã", callback_data="show_help")],
    ]
    return InlineKeyboardMarkup(keyboard)


HELP_TEXT = (
    "–ö–æ–º–∞–Ω–¥—ã:\n"
    "/start ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n"
    "/status ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤\n"
    "/on_tvoi, /off_tvoi ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å TVOI\n"
    "/on_trnd, /off_trnd ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å TRND\n"
    "\n"
    "–ö–Ω–æ–ø–∫–∏: –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç —Ä–µ–∂–∏–º—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ."
)


# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–æ–≤ (–º—è–≥–∫–∞—è) ---
def _is_admin(user_id: int) -> bool:
    if not ADMINS:
        # –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        return True
    return str(user_id) in ADMINS


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ PTB v20 ---
async def _start_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.effective_user or not _is_admin(update.effective_user.id):
        return
    st = get_state()
    await update.message.reply_text("InnerTrade Screener ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞–º–∏", reply_markup=build_keyboard(st))


async def _status_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.effective_user or not _is_admin(update.effective_user.id):
        return
    st = get_state()
    msg = f"üì° TVOI: {'ON' if st['tvoi'] else 'OFF'}\nüìà TRND: {'ON' if st['trnd'] else 'OFF'}"
    await update.message.reply_text(msg, reply_markup=build_keyboard(st))


async def _help_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.effective_user or not _is_admin(update.effective_user.id):
        return
    await update.message.reply_text(HELP_TEXT)


async def _cb_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    if not q:
        return
    user = q.from_user
    if not user or not _is_admin(user.id):
        await q.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return

    st = get_state()
    if q.data == "toggle_tvoi":
        st = set_state({"tvoi": not st["tvoi"]})
        await q.answer(f"TVOI ‚Üí {'ON' if st['tvoi'] else 'OFF'}")
    elif q.data == "toggle_trnd":
        st = set_state({"trnd": not st["trnd"]})
        await q.answer(f"TRND ‚Üí {'ON' if st['trnd'] else 'OFF'}")
    elif q.data == "show_help":
        await q.answer("–ö–æ–º–∞–Ω–¥—ã")
        await q.message.reply_text(HELP_TEXT)
    else:
        await q.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞")

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ —Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–∏
    try:
        await q.message.edit_reply_markup(reply_markup=build_keyboard(st))
    except Exception:
        # –µ—Å–ª–∏ –Ω–µ–ª—å–∑—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ
        await q.message.reply_text("–û–±–Ω–æ–≤–ª–µ–Ω–æ", reply_markup=build_keyboard(st))


async def _on_tvoi_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.effective_user or not _is_admin(update.effective_user.id):
        return
    st = set_state({"tvoi": True})
    await update.message.reply_text("TVOI –≤–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


async def _off_tvoi_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.effective_user or not _is_admin(update.effective_user.id):
        return
    st = set_state({"tvoi": False})
    await update.message.reply_text("TVOI –≤—ã–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


async def _on_trnd_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.effective_user or not _is_admin(update.effective_user.id):
        return
    st = set_state({"trnd": True})
    await update.message.reply_text("TRND –≤–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


async def _off_trnd_v20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.effective_user or not _is_admin(update.effective_user.id):
        return
    st = set_state({"trnd": False})
    await update.message.reply_text("TRND –≤—ã–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


def run_v20():
    if not MENU_BOT_TOKEN:
        logger.error("MENU_BOT_TOKEN is not set")
        sys.exit(1)
    app = Application.builder().token(MENU_BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", _start_v20))
    app.add_handler(CommandHandler("status", _status_v20))
    app.add_handler(CommandHandler("help", _help_v20))
    app.add_handler(CommandHandler("on_tvoi", _on_tvoi_v20))
    app.add_handler(CommandHandler("off_tvoi", _off_tvoi_v20))
    app.add_handler(CommandHandler("on_trnd", _on_trnd_v20))
    app.add_handler(CommandHandler("off_trnd", _off_trnd_v20))
    app.add_handler(CallbackQueryHandler(_cb_v20))

    logger.info("menu_bot started (PTB v20)")
    app.run_polling(drop_pending_updates=True)


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ PTB v13 (fallback) ---
def _start_v13(update, context):
    user = update.effective_user
    if not user or not _is_admin(user.id):
        return
    st = get_state()
    context.bot.send_message(chat_id=update.effective_chat.id,
                             text="InnerTrade Screener ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞–º–∏",
                             reply_markup=build_keyboard(st))


def _status_v13(update, context):
    user = update.effective_user
    if not user or not _is_admin(user.id):
        return
    st = get_state()
    msg = f"üì° TVOI: {'ON' if st['tvoi'] else 'OFF'}\nüìà TRND: {'ON' if st['trnd'] else 'OFF'}"
    context.bot.send_message(chat_id=update.effective_chat.id, text=msg, reply_markup=build_keyboard(st))


def _help_v13(update, context):
    user = update.effective_user
    if not user or not _is_admin(user.id):
        return
    context.bot.send_message(chat_id=update.effective_chat.id, text=HELP_TEXT)


def _cb_v13(update, context):
    q = update.callback_query
    if not q:
        return
    user = q.from_user
    if not user or not _is_admin(user.id):
        context.bot.answer_callback_query(q.id, text="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return

    st = get_state()
    if q.data == "toggle_tvoi":
        st = set_state({"tvoi": not st["tvoi"]})
        context.bot.answer_callback_query(q.id, text=f"TVOI ‚Üí {'ON' if st['tvoi'] else 'OFF'}")
    elif q.data == "toggle_trnd":
        st = set_state({"trnd": not st["trnd"]})
        context.bot.answer_callback_query(q.id, text=f"TRND ‚Üí {'ON' if st['trnd'] else 'OFF'}")
    elif q.data == "show_help":
        context.bot.answer_callback_query(q.id, text="–ö–æ–º–∞–Ω–¥—ã")
        context.bot.send_message(chat_id=update.effective_chat.id, text=HELP_TEXT)
    else:
        context.bot.answer_callback_query(q.id, text="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞")

    # –æ–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    try:
        context.bot.edit_message_reply_markup(
            chat_id=update.effective_chat.id,
            message_id=q.message.message_id,
            reply_markup=build_keyboard(st)
        )
    except Exception:
        context.bot.send_message(chat_id=update.effective_chat.id, text="–û–±–Ω–æ–≤–ª–µ–Ω–æ", reply_markup=build_keyboard(st))


def _on_tvoi_v13(update, context):
    user = update.effective_user
    if not user or not _is_admin(user.id):
        return
    st = set_state({"tvoi": True})
    context.bot.send_message(chat_id=update.effective_chat.id, text="TVOI –≤–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


def _off_tvoi_v13(update, context):
    user = update.effective_user
    if not user or not _is_admin(user.id):
        return
    st = set_state({"tvoi": False})
    context.bot.send_message(chat_id=update.effective_chat.id, text="TVOI –≤—ã–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


def _on_trnd_v13(update, context):
    user = update.effective_user
    if not user or not _is_admin(user.id):
        return
    st = set_state({"trnd": True})
    context.bot.send_message(chat_id=update.effective_chat.id, text="TRND –≤–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


def _off_trnd_v13(update, context):
    user = update.effective_user
    if not user or not _is_admin(user.id):
        return
    st = set_state({"trnd": False})
    context.bot.send_message(chat_id=update.effective_chat.id, text="TRND –≤—ã–∫–ª—é—á–µ–Ω", reply_markup=build_keyboard(st))


def run_v13():
    if not MENU_BOT_TOKEN:
        logger.error("MENU_BOT_TOKEN is not set")
        sys.exit(1)
    updater = Updater(token=MENU_BOT_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", _start_v13))
    dp.add_handler(CommandHandler("status", _status_v13))
    dp.add_handler(CommandHandler("help", _help_v13))
    dp.add_handler(CommandHandler("on_tvoi", _on_tvoi_v13))
    dp.add_handler(CommandHandler("off_tvoi", _off_tvoi_v13))
    dp.add_handler(CommandHandler("on_trnd", _on_trnd_v13))
    dp.add_handler(CommandHandler("off_trnd", _off_trnd_v13))
    dp.add_handler(CallbackQueryHandler(_cb_v13))

    logger.info("menu_bot started (PTB v13)")
    updater.start_polling(drop_pending_updates=True)
    updater.idle()


if __name__ == "__main__":
    logger.info("Starting menu_bot ‚Ä¶")
    STATE_DIR.mkdir(parents=True, exist_ok=True)
    # ensure state exists
    if not STATE_FILE.exists():
        _atomic_write_json(STATE_FILE, DEFAULT_STATE)
        logger.info("State initialized: %s", DEFAULT_STATE)

    # –∑–∞–ø—É—Å–∫ –ø–æ–¥ –ø–æ–¥—Ö–æ–¥—è—â—É—é –≤–µ—Ä—Å–∏—é PTB
    if PTB_VERSION >= 20:
        run_v20()
    else:
        run_v13()
